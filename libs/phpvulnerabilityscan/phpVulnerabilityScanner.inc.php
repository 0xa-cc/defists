<?php
//@ob_start();
set_time_limit(99999);

/**
 * Class to scan Vulnerability in PHP / JS files on a live server.
 *
 *@author Rochak Chauhan
 */
class PhpVulnerabilityScanner {
	private $dir="./";
	private $vulnerabileFilesArray=array();
	private $toScanArray=array("base64_encode", "base64_decode", "unescape");
	
	/**
	 * Contructor Function
	 *
	 *@author Rochak Chauhan
	 *@param string $dir
	 *@param array $toScanArray
	 *@access public
	 *
	 *@return resource
	 */
	public function PhpVulnerabilityScanner($dir="",$toScanArray=""){
			if( (!empty($dir)) && is_string($dir) )  {
				$this->dir=$dir;			
			}
			if( is_array($toScanArray) && (count($toScanArray)>0) )  {
				$this->toScanArray=$toScanArray;		
			}
	}
	
	/**
	 * Function to start displaying the results on screen
	 *
	 *@author Rochak Chauhan
	 *@access public
	 *
	 *@return string
	 */
	public function showResult(){		
		echo "<div>Scanning Starts...</div>";
		flush(); ob_flush();
		$this->parseDirectory($this->dir);
		echo "<div>Scanning Ends. <div>Visit <a target='_blank' href='http://www.rochakchauhan.com/'>My Blog</a>  | <a target='_blank' href='http://www.dmwtechnologies.com/'>My Company</a></div></div>";
		flush(); ob_flush();
	}	
	
	/**
	 *Function to check if a file contains some possible Malicious code
	 *
	 *@author Rochak Chauhan
	 *@param string $fileName
	 *@access private
	 *
	 *@return boolean
	 */
	private function isFileVulnerabile($fileName){
		if(is_file($fileName)){
			$fileContent=file_get_contents($fileName);			
			foreach($this->toScanArray as $toSearch){
				$substrCount=substr_count($fileContent,$toSearch);
				if ($substrCount>0){ return true; }
			}
		}
		return false;
	}
	
	/**
	 *Function to parse each and every directory and subdirectory for scanning
	 *
	 *@author Rochak Chauhan
	 *@param string $rootPath
	 *@param string $seperator
	 *@access private
	 *
	 *@return void
	 */
	private function parseDirectory($rootPath, $seperator="/"){			
		if (($handle = opendir($rootPath))!==false) {		
			while( ($file = readdir($handle))!==false) {				
				if($file !='.' && $file !='..'){					
					if (is_dir($rootPath.$seperator.$file)){						
						$this->parseDirectory($rootPath.$seperator.$file);				
						//$this->vulnerabileFilesArray=array_merge($array,$this->vulnerabileFilesArray);						
						if($this->isFileVulnerabile($rootPath.$seperator.$file)===true){
							$link=str_replace("..","",$rootPath.$seperator.$file);
							echo "<div><b>Possible Vulnerabile File:</b> $rootPath.$seperator.$file <a href='$link' target='_blank'>View File</a></div>";
							flush(); ob_flush();
						}
					}
					else {						
						if($this->isFileVulnerabile($rootPath.$seperator.$file)){
							//$this->vulnerabileFilesArray[]=$rootPath.$seperator.$file;
							$link=str_replace("..","",$rootPath.$seperator.$file);
							echo "<div><b>Possible Vulnerabile File:</b> $rootPath.$seperator.$file <a href='$link' target='_blank'>View File</a></div>";
							flush(); ob_flush();
						}
					}
				}
			}
		}		
	}
}
?>